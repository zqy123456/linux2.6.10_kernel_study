一种基于高性能线程集调度的分布式防火墙板间通信技术

网络安全的意识在用户使用网络设备过程中越来越被重视，在安全的基础领域，分布式防火墙被大量使用，同时对防火墙设备的认知也越来越深刻。在很多领域，如政府、银行、金融等政企行业，安全已经成为用户考虑的首要因素，对防火墙设备的需求也与日俱增，根据行业自身的特点，对防火墙的功能提出特别需求，而这其中，对分布式防火墙的功能的要求也越来越高。而目前分布式防火墙的主要特点和优势主要包括如下几点：（1）增强的系统安全性，针对主机的入侵检测和防护功能，加强了来自内部的攻击防护，实现全方位的安全策略。（2）提高系统的性能，利用硬件层次将业务模块、管理模块、控制模块、部分模块等使用不同的硬件和软件系统来实现，各司其职提高整体的性能。（3）系统的扩展性，在硬件和软件层面实现对分布式防火墙的扩充。本发明的方法主要是基于分布式防火墙的第二特点，提高分布式防火墙设备性能的角度出发，在管理模块和业务模块中使用一种高性能线程集的通信技术，来提高分布式防火墙设备板间的通信能力，接下来将具体的描述：
如图1所示，是某一分布式防火墙的硬件架构示意图，一般分布式防火墙都由业务板与主控板两个部分组成，实现控制与业务的划分，复杂的防火墙还会将业务部进一步细分，如接口业务和安全业务进行独立分工。从图可以看出，在所有的单板之前都需要进行通信功能，可以具体的了解到，每个业务板都会与主控板相连接，进行数据通信，其中①②表示主控和业务板之间的通信，③表示主用主控板与备用主控板之间的通信。不管怎样硬件结构怎样的设计，图中○1、○2、○3所示的部分都需要进行信息的交互。
图2给出了，分布式防火墙硬件模块的通信逻辑示意图，其中图中实线所示的链接是将防火墙的硬件链路进行了抽象，而红色的虚线代表在逻辑上，每个单板直接进行的数据通信，也就是，在逻辑上，只要通过硬件链路连接在一起的单板，每个单板之间都需要进行数据通信，防火墙设备有N个单板，逻辑上就会构成2*N条边的图，不过在硬件链路层可以复用接口进行通信。



分布式防火墙的需要主控板和业务板之间进行数据的通信，确保各个单板上的系统都实时的更新设备上所有的单板的信息和一些数据，所以需要一套通信机制，能够在系统的启动早期进行数据的通信（一般在Linux内核启动之后就需要各个单板能进行数据通信，当然在系统启动之后也可以进行通信），为了实现单板之间的信息快速交互，在每个单板系统中都需要实现一套并发量大，及时响应的通信机制，并且根据具体的信息需求，实现对数据传输的同步和异步方式。




本发明是一种基于高性能线程集的分布式通信技术，图3是本发明方案的一个完整的层次结构示意图：
1、	在最底层是硬件物理链路层，这层主要包括，单板之间的链接模式，如通过SGMII协议链接。
2、	网络接口抽象层，主要是将网卡或交换芯片等MAC和PHY层，统一为一个网络接口，用于发送或接受报文使用。
3、	数据通道统一接口层，在网络接口抽象层的基础之上，进行统一封装，实现功能不同的传送要求及功能，如单播，广播传输等。
4、	数据传送方式的不同可以分为同步和异步，主要根据上次用户的需求，对需要的传送信息是否需要实时的返回。
5、	业务层主要是提供一些功能，让用户选择发送怎样的数据，以及怎样的方式等。





本发明主要实施的流程图如下：





其主要内容如下：
（1）、创建全局数据结构体，保存需要同步的信息或业务层需要进行通信的信息，这些信息包括硬件设计的信息、功能实现信息、用户需求信息等。
（2）、创建一个全局等待队列的标识，根据同步信息类型的不同设置不同标识。目的是在发送或接收时对不同的通信信息进行区分。
（3）、创建一个定时器机制，每隔一定时间触发，调用相应的定时器处理服务进程，这个服务进程主要在全局等待队列中写入一个同步信息的标识，目的是触发某一类型的信息进行通信。
（4）、创建一个高性能线程集，这个高性能线程集主要由线程服务进程和epoll机制组成，其主要工作就是利用epoll机制监听等待队列上的同步信息标识是否改变，从而判断是否进行数据的同步更新，主要流程如图5所示：


（5）、定义基本的统一接口，包括同步、异步通道的接口，数据通道的统一接口，网络抽象层的接口，这些接口基本上都包含发送和接收数据或报文等功能。同时设置一个全局变量结构体，作为注册机制，用来保存统一接口的函数，结构体内使用函数指针来实现这一目的。这个注册机制同时也会记录不同接口的ID值，接口的处理函数优先级，是否建立连接、是不同步返回的标识。
（6）、根据定时间的时间间隔，触发定时器服务进程，此服务进行中会包含如图5所描述的高性能线程集，然后对需要同步更新的数据进行封装，调用下一层的接口，就会根据接口函数的功能不同，对数据在进行一次封装，一次类推，知道最后到网络接口抽象层，封装结束，此时的数据以及被封装成一个网络报文了，从硬件物理链路层发送出去。
（7）与第（6）步对应的是接收到同步数据时，从底层到上一层，每次多都对接收到报文进行拆分，剥去每一层特有数据头信息，最后到达需要不同的业务层。如图6所示显示了数据进行通信的基本流程：





（1）、本发明方案解决了背景中阐述的为了提高分布式防火墙的整体通信性能，目的是在系统启动的同时进行数据的交互，使各个独立的单板系统感知整个设备各个单板的信息，为整个设备启动后的协同工作提供基础。
（2）、本发明使用了自定义了一套分布式通信的层次逻辑结构，实现了在分布式设备下多单板、多系统条件下的一套逻辑通信结构。
（3）、分发明使用了Linux内核的定时器、等待队列、多线程、epoll机制等多技术实现了一种通信技术，凸显了对多知识的结合和多技能的综合应用，从而实现了分布式防火墙各单板之间实时的通信。



目前还没有找到相类似的替代方案技术；


（1）、本发明所定义的通信机制的逻辑层次结构，包括每一层定义的具体内容及实现此层逻辑功能的所有数据结构、机制等。
（2）、发明方法所需要的基本条件，包括全局数据结构体、定时器、epoll机制、等待队列标识等。
（3）、发明方法所需要的基本机制，包括轮询机制和内核线程集。
（4）、发明所需要的基本统一接口，包括同步、异步通道，数据通道统一接口、网络抽象层接口。
